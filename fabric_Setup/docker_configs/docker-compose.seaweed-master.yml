# SeaweedFS Standalone Test - Master Node
# Run on: 10.96.122.9
#
# Usage:
#   cd docker_configs && docker compose -f docker-compose.seaweed-master.yml up -d
#
# This runs master, filer, volume, and mount on the master node.
# Workers connect to this master at port 9333.

services:
  seaweed-master:
    image: chrislusf/seaweedfs
    container_name: dm_seaweed_master
    restart: unless-stopped
    command: master -ip=seaweed-master -defaultReplication=000 -volumeSizeLimitMB=1000
    ports:
      - "9333:9333" # Master HTTP
      - "19333:19333" # Master gRPC
    volumes:
      - /data/seaweed/master:/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9333/dir/status" ]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  seaweed-volume:
    image: chrislusf/seaweedfs
    container_name: dm_seaweed_volume
    restart: unless-stopped
    command: volume -mserver=seaweed-master:9333 -ip=seaweed-volume -dir=/data -max=100
    depends_on:
      seaweed-master:
        condition: service_healthy
    volumes:
      - /data/seaweed/volume:/data

  seaweed-filer:
    image: chrislusf/seaweedfs
    container_name: dm_seaweed_filer
    restart: unless-stopped
    command: filer -master=seaweed-master:9333 -ip=seaweed-filer
    depends_on:
      seaweed-master:
        condition: service_healthy
      seaweed-volume:
        condition: service_started
    ports:
      - "8888:8888" # Filer HTTP
      - "18888:18888" # Filer gRPC
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8888/" ]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 15s

  # FUSE mount with host access
  seaweed-mount:
    image: chrislusf/seaweedfs
    container_name: dm_seaweed_mount
    restart: unless-stopped
    user: root
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        # Ensure mount point exists
        mkdir -p /mnt/seaweed
        # Wait for filer
        sleep 5
        # Mount with allow_other to allow host access
        exec /usr/bin/weed mount -filer=seaweed-filer:8888 -dir=/mnt/seaweed -filer.path=/ -allowOthers=true
    privileged: true
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    depends_on:
      seaweed-filer:
        condition: service_healthy
    volumes:
      # Bidirectional bind mount to expose to host
      # Requires host path to be a shared mount point
      - type: bind
        source: /mnt/seaweed
        target: /mnt/seaweed
        bind:
          propagation: shared
