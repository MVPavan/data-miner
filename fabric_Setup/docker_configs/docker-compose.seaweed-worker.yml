# SeaweedFS Standalone Test - Worker Node
# Run on workers: 10.96.122.14, 10.96.122.132
#
# Usage:
#   export PUBLIC_IP=$(hostname -I | awk '{print $1}')
#   sudo -E docker compose -f docker-compose.seaweed-worker.yml up -d

services:
  seaweed-volume:
    image: chrislusf/seaweedfs
    container_name: dm_seaweed_volume
    restart: unless-stopped
    # Bind to 0.0.0.0 inside container, but advertise PUBLIC_IP to master
    command: volume -mserver=10.96.122.9:9333 -port=8080 -ip.bind=0.0.0.0 -ip=${PUBLIC_IP} -publicUrl=${PUBLIC_IP}:8080 -dir=/data -max=100
    ports:
      - "8080:8080"
      - "18080:18080"
    volumes:
      - /data/seaweed/volume:/data

  seaweed-mount:
    image: chrislusf/seaweedfs
    container_name: dm_seaweed_mount
    restart: unless-stopped
    user: root
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        # Ensure mount point exists
        mkdir -p /mnt/seaweed
        # Wait for volume server to be ready
        sleep 5
        # Mount with allow_other to allow host access
        exec /usr/bin/weed mount -filer=10.96.122.9:8888 -dir=/mnt/seaweed -filer.path=/ -allowOthers=true
    privileged: true
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN
    volumes:
      # Bidirectional bind mount to expose to host
      - type: bind
        source: /mnt/seaweed
        target: /mnt/seaweed
        bind:
          propagation: rshared
