# =============================================================================
# K3s Cluster Configuration â€” Single Source of Truth
# =============================================================================
# All infrastructure scripts (provision.py, orchestrate.py, generate_manifests.py)
# read from this file via cluster.py. Project-specific app config lives in
# run_configs/*.yaml files.
# =============================================================================

cluster:
  namespace: data-miner
  k3s_version: "v1.31.0+k3s1"
  ssh_key: "~/.ssh/id_rsa_dm_k3s"

  nodes:
    pavanjci:
      ip: "10.96.122.9"
      role: master
      ssh_user: pavanmv
      labels:
        gpu: "true"
    manthana:
      ip: "10.96.122.132"
      role: worker
      ssh_user: pavanmv
    arsenal:
      ip: "10.96.122.14"
      role: worker
      ssh_user: pavan

storage:
  seaweedfs_mount: /swdfs_mnt/swshared
  db_path: /data/data_miner_db
  db_services:
    postgres: 999
    loki: 10001
    grafana: 472

image:
  name: data-miner
  tag: latest
  pull_policy: Never

seaweedfs:
  namespace: seaweedfs
  image: chrislusf/seaweedfs:latest
  data_dir: /data/seaweed
  schedule_on: master

nvidia:
  plugin_version: "v0.14.0"

database_url: "postgresql://postgres:postgres@postgres.${cluster.namespace}.svc.cluster.local:5432/data_miner"
loki_url: "http://loki.${cluster.namespace}.svc.cluster.local:3100/loki/api/v1/push"

# K8s overrides merged on top of default.yaml + run_config when generating ConfigMap
k3s_app_overrides:
  output_dir: "${storage.seaweedfs_mount}/data_miner_output"
  device: "auto"
  logging:
    log_dir: "${storage.seaweedfs_mount}/data_miner_output/logs"

resource_presets:
  small:
    requests: { cpu: "250m", memory: "512Mi" }
    limits:   { cpu: "1000m", memory: "2Gi" }
  medium:
    requests: { cpu: "500m", memory: "1Gi" }
    limits:   { cpu: "2000m", memory: "4Gi" }
  gpu:
    requests: { cpu: "500m", memory: "2Gi" }
    limits:   { cpu: "2000m", memory: "8Gi" }

workers:
  download:
    kind: StatefulSet
    replicas: 3
    resources: ${resource_presets.small}
    schedule_on: all
    extra_env:
      - name: POD_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.name

  extract:
    replicas: 2
    resources: ${resource_presets.medium}
    schedule_on: master

  filter:
    replicas: 1
    resources: ${resource_presets.gpu}
    schedule_on: gpu
    hf_token: true

  dedup:
    replicas: 0
    resources: ${resource_presets.gpu}
    schedule_on: gpu
    hf_token: true

  detect:
    replicas: 0
    resources: ${resource_presets.gpu}
    schedule_on: gpu
    hf_token: true

  monitor:
    replicas: 1
    resources: ${resource_presets.medium}
    schedule_on: master

# =============================================================================
# Infrastructure Services (postgres, loki, grafana, adminer)
# =============================================================================
infrastructure:
  postgres:
    kind: StatefulSet
    image: postgres:16
    port: 5432
    service_type: headless
    schedule_on: master
    resources:
      requests: { cpu: "250m", memory: "256Mi" }
      limits: { cpu: "1000m", memory: "1Gi" }
    data_dir: ${storage.db_path}/postgres
    volume_mount: /var/lib/postgresql/data
    env:
      - name: POSTGRES_USER
        value: "postgres"
      - name: POSTGRES_PASSWORD
        value: "postgres"
      - name: POSTGRES_DB
        value: "data_miner"
      - name: PGDATA
        value: "/var/lib/postgresql/data/pgdata"
    liveness_probe:
      command: ["pg_isready", "-U", "postgres", "-d", "data_miner"]
      initial_delay: 30
      period: 10
    readiness_probe:
      command: ["pg_isready", "-U", "postgres", "-d", "data_miner"]
      initial_delay: 5
      period: 5

  loki:
    kind: StatefulSet
    image: grafana/loki:2.9.0
    port: 3100
    service_type: ClusterIP
    schedule_on: master
    resources:
      requests: { cpu: "100m", memory: "256Mi" }
      limits: { cpu: "500m", memory: "512Mi" }
    data_dir: ${storage.db_path}/loki
    volume_mount: /loki
    args: ["-config.file=/etc/loki/local-config.yaml"]

  grafana:
    kind: Deployment
    image: grafana/grafana:10.0.0
    port: 3000
    node_port: 30300
    service_type: NodePort
    schedule_on: master
    resources:
      requests: { cpu: "100m", memory: "128Mi" }
      limits: { cpu: "500m", memory: "256Mi" }
    data_dir: ${storage.db_path}/grafana
    volume_mount: /var/lib/grafana
    env:
      - name: GF_AUTH_ANONYMOUS_ENABLED
        value: "true"
      - name: GF_AUTH_ANONYMOUS_ORG_ROLE
        value: "Admin"

  adminer:
    kind: Deployment
    image: adminer:latest
    port: 8080
    node_port: 30080
    service_type: NodePort
    schedule_on: master
    resources:
      requests: { cpu: "50m", memory: "64Mi" }
      limits: { cpu: "500m", memory: "256Mi" }
